
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>&lt;no title&gt; &#8212; Annolid Documentation</title>
    
  <link href="../../_static/css/theme.css" rel="stylesheet">
  <link href="../../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/togglebutton.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../_static/sphinx-book-theme.d59cb220de22ca1c485ebbdc042f0030.js"></script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script>
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../../_static/cpl_logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Annolid Documentation</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../content/README.html">
   Annolid Documentation
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Getting Started
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../content/introduction.html">
   Introduction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../content/high_level_overview.html">
   High level overview
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../content/how_to_install.html">
   How to install
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../content/docker_container.html">
   Docker
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../content/gui_or_cli.html">
   GUI or CLI ?
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../content/labelling_images.html">
   How to label images
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../content/tips_and_tricks.html">
   Tips and tricks
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Annolid Zoo
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../content/annolid_zoo.html">
   Annolid ModelZoo
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Community
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../content/contributing.html">
   New contributor guide
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../content/get_in_touch.html">
   Get in touch
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../content/licence.html">
   Licence
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../content/cite_annolid.html">
   Cite Annolid
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../content/work_based_on_annolid.html">
   Work based on annolid
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../../_sources/tutorials/tutorials/Self_supervised_optical_flow_estimation.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
                onclick="printPdf(this)" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/jeremyforest/annolid/"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/jeremyforest/annolid//issues/new?title=Issue%20on%20page%20%2Ftutorials/tutorials/Self_supervised_optical_flow_estimation.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/jeremyforest/annolid/master?urlpath=tree/book/tutorials/tutorials/Self_supervised_optical_flow_estimation.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show noprint">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="simple visible nav section-nav flex-column">
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1><no title></h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="simple visible nav section-nav flex-column">
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            
              <div>
                
  <p><a href="https://colab.research.google.com/github/healthonrails/annolid/blob/main/docs/tutorials/Self_supervised_optical_flow_estimation.ipynb" target="_blank"><img src="https://colab.research.google.com/assets/colab-badge.svg" alt="Open In Colab"/></a></p>
<p><strong>Self-supervised optical flow estimation</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">division</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="kn">import</span> <span class="nn">torchvision.transforms</span> <span class="k">as</span> <span class="nn">T</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">Dataset</span><span class="p">,</span> <span class="n">DataLoader</span><span class="p">,</span> <span class="n">IterableDataset</span>
<span class="kn">from</span> <span class="nn">torchvision</span> <span class="kn">import</span> <span class="n">transforms</span><span class="p">,</span> <span class="n">utils</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="nn">F</span>
<span class="kn">from</span> <span class="nn">torch.distributions.normal</span> <span class="kn">import</span> <span class="n">Normal</span>
<span class="kn">from</span> <span class="nn">google.colab.patches</span> <span class="kn">import</span>  <span class="n">cv2_imshow</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Ignore warnings</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ion</span><span class="p">()</span>   <span class="c1"># interactive mode</span>
<span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;KMP_DUPLICATE_LIB_OK&quot;</span><span class="p">]</span><span class="o">=</span><span class="s2">&quot;TRUE&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># please uncomment the following lines if you want to</span>
<span class="c1"># upload a video file from your local file system</span>
<span class="c1"># from google.colab import files</span>
<span class="c1"># uploaded = files.upload()</span>
<span class="c1"># VIDEO_PATH =  list(uploaded.keys())[0]  #&quot;/content/freeze.mkv&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Please update the following line to change the video path</span>
<span class="n">VIDEO_PATH</span> <span class="o">=</span> <span class="s1">&#39;/content/video.mp4&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># code adapted from here</span>
<span class="c1"># https://github.com/NVIDIA/flownet2-pytorch/blob/master/utils/flow_utils.py</span>

<span class="n">TAG_CHAR</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">202021.25</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">write_flow</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">uv</span><span class="p">,</span><span class="n">v</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Write optical flow to file.</span>
<span class="sd">    </span>
<span class="sd">    If v is None, uv is assumed to contain both u and v channels,</span>
<span class="sd">    stacked in depth.</span>
<span class="sd">    Original code by Deqing Sun, adapted from Daniel Scharstein.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nBands</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">uv</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">uv</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">uv</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">uv</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">uv</span>

    <span class="k">assert</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">height</span><span class="p">,</span><span class="n">width</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s1">&#39;wb&#39;</span><span class="p">)</span>
    <span class="c1"># write the header</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">TAG_CHAR</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">width</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span><span class="o">.</span><span class="n">tofile</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">height</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span><span class="o">.</span><span class="n">tofile</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="c1"># arrange into matrix form</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="o">*</span><span class="n">nBands</span><span class="p">))</span>
    <span class="n">tmp</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">width</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span>
    <span class="n">tmp</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">width</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
    <span class="n">tmp</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">tofile</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">VideoFrameDataset</span><span class="p">(</span><span class="n">IterableDataset</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Video Frame dataset.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">video_file</span><span class="p">,</span> <span class="n">root_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            video_file (string): Path to the video file.</span>
<span class="sd">            root_dir (string): Directory with all the videos.</span>
<span class="sd">            transform (callable, optional): Optional transform to be applied</span>
<span class="sd">                on a sample.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">video_file</span> <span class="o">=</span> <span class="n">video_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">=</span> <span class="n">root_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">transform</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cap</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoCapture</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">video_file</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">frame_width</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FRAME_WIDTH</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">frame_height</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FRAME_HEIGHT</span><span class="p">))</span>
        

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="n">ret</span><span class="p">,</span> <span class="n">old_frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cap</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">num_frames</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FRAME_COUNT</span><span class="p">)))</span>
        <span class="n">old_frame</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">old_frame</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_frames</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">ret</span><span class="p">,</span><span class="n">frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cap</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="c1">#frame_gray = cv2.cvtColor(frame, cv2.COLOR_BGR2GRAY)</span>
            <span class="k">if</span> <span class="n">ret</span><span class="p">:</span>
                <span class="n">frame</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">frame</span> <span class="o">=</span> <span class="n">old_frame</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">old_frame</span><span class="p">)</span>
                <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">old_frame</span>
                <span class="n">y</span> <span class="o">=</span> <span class="n">frame</span>
            <span class="n">old_frame</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="k">yield</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span>
    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">destroyAllWindows</span><span class="p">()</span>
        <span class="n">cap</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">video_dataset</span> <span class="o">=</span> <span class="n">VideoFrameDataset</span><span class="p">(</span><span class="n">VIDEO_PATH</span><span class="p">)</span>
<span class="n">video_height</span> <span class="o">=</span> <span class="n">video_dataset</span><span class="o">.</span><span class="n">frame_height</span><span class="p">()</span>
<span class="n">video_width</span> <span class="o">=</span> <span class="n">video_dataset</span><span class="o">.</span><span class="n">frame_width</span><span class="p">()</span>
<span class="n">vol_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">video_height</span><span class="p">,</span><span class="n">video_width</span><span class="p">)</span>
<span class="n">loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">video_dataset</span><span class="p">,</span><span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ConvBlock</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reference:</span>
<span class="sd">    From here. </span>
<span class="sd">    https://github.com/voxelmorph/voxelmorph/blob/master/voxelmorph/torch/networks.py</span>
<span class="sd">    Specific convolutional block followed by leakyrelu for unet.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ndims</span><span class="p">,</span> <span class="n">in_channels</span><span class="p">,</span> <span class="n">out_channels</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="n">Conv</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">nn</span><span class="p">,</span> <span class="s1">&#39;Conv</span><span class="si">%d</span><span class="s1">d&#39;</span> <span class="o">%</span> <span class="n">ndims</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main</span> <span class="o">=</span> <span class="n">Conv</span><span class="p">(</span><span class="n">in_channels</span><span class="p">,</span> <span class="n">out_channels</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">stride</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activation</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">LeakyReLU</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">main</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">activation</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Unet</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reference:</span>
<span class="sd">    Modified from here. </span>
<span class="sd">    https://github.com/voxelmorph/voxelmorph/blob/master/voxelmorph/torch/networks.py</span>
<span class="sd">    </span>
<span class="sd">    A unet architecture. Layer features can be specified directly as a list of encoder and decoder</span>
<span class="sd">    features or as a single integer along with a number of unet levels. The default network features</span>
<span class="sd">    per layer (when no options are specified) are:</span>
<span class="sd">        encoder: [16, 32, 32, 32]</span>
<span class="sd">        decoder: [32, 32, 32, 32, 32, 16, 16]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inshape</span><span class="p">,</span> <span class="n">nb_features</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nb_levels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">feat_mult</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters:</span>
<span class="sd">            inshape: Input shape. e.g. (192, 192, 192)</span>
<span class="sd">            nb_features: Unet convolutional features. Can be specified via a list of lists with</span>
<span class="sd">                the form [[encoder feats], [decoder feats]], or as a single integer. If None (default),</span>
<span class="sd">                the unet features are defined by the default config described in the class documentation.</span>
<span class="sd">            nb_levels: Number of levels in unet. Only used when nb_features is an integer. Default is None.</span>
<span class="sd">            feat_mult: Per-level feature multiplier. Only used when nb_features is an integer. Default is 1.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># ensure correct dimensionality</span>
        <span class="n">ndims</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">inshape</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">ndims</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="s1">&#39;ndims should be one of 1, 2, or 3. found: </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ndims</span>

        <span class="c1"># build feature list automatically</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nb_features</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">nb_levels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;must provide unet nb_levels if nb_features is an integer&#39;</span><span class="p">)</span>
            <span class="n">feats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">nb_features</span> <span class="o">*</span> <span class="n">feat_mult</span> <span class="o">**</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nb_levels</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">enc_nf</span> <span class="o">=</span> <span class="n">feats</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dec_nf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">feats</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">nb_levels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;cannot use nb_levels if nb_features is not an integer&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">enc_nf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec_nf</span> <span class="o">=</span> <span class="n">nb_features</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">upsample</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Upsample</span><span class="p">(</span><span class="n">scale_factor</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>

        <span class="c1"># configure encoder (down-sampling path)</span>
        <span class="n">prev_nf</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">downarm</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">nf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">enc_nf</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">downarm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ConvBlock</span><span class="p">(</span><span class="n">ndims</span><span class="p">,</span> <span class="n">prev_nf</span><span class="p">,</span> <span class="n">nf</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
            <span class="n">prev_nf</span> <span class="o">=</span> <span class="n">nf</span>

        <span class="c1"># configure decoder (up-sampling path)</span>
        <span class="n">enc_history</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">enc_nf</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uparm</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">nf</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dec_nf</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">enc_nf</span><span class="p">)]):</span>
            <span class="n">channels</span> <span class="o">=</span> <span class="n">prev_nf</span> <span class="o">+</span> <span class="n">enc_history</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">prev_nf</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uparm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ConvBlock</span><span class="p">(</span><span class="n">ndims</span><span class="p">,</span> <span class="n">channels</span><span class="p">,</span> <span class="n">nf</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">prev_nf</span> <span class="o">=</span> <span class="n">nf</span>

        <span class="c1"># configure extra decoder convolutions (no up-sampling)</span>
        <span class="n">prev_nf</span> <span class="o">+=</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extras</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">nf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec_nf</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">enc_nf</span><span class="p">):]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">extras</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ConvBlock</span><span class="p">(</span><span class="n">ndims</span><span class="p">,</span> <span class="n">prev_nf</span><span class="p">,</span> <span class="n">nf</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">prev_nf</span> <span class="o">=</span> <span class="n">nf</span>
 
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>

        <span class="c1"># get encoder activations</span>
        <span class="n">x_enc</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">downarm</span><span class="p">:</span>
            <span class="n">x_enc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer</span><span class="p">(</span><span class="n">x_enc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>

        <span class="c1"># conv, upsample, concatenate series</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x_enc</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">uparm</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">layer</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">upsample</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">_x</span> <span class="o">=</span> <span class="n">x_enc</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">_x</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>            
                <span class="n">x3d</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">_x3d</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">_x</span><span class="o">.</span><span class="n">shape</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">x3d</span> <span class="o">&gt;</span> <span class="n">_x3d</span> <span class="p">:</span>
                    <span class="n">pd</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">x3d</span><span class="o">-</span><span class="n">_x3d</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">_x</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">_x</span><span class="p">,</span> <span class="n">pd</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">x3d</span> <span class="o">&lt;</span> <span class="n">_x3d</span><span class="p">:</span>
                    <span class="n">pd</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">_x3d</span><span class="o">-</span><span class="n">x3d</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">pd</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">_x</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># extra convs at full resolution</span>
        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">extras</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">layer</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SpatialTransformer</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    [SpatialTransformer] represesents a spatial transformation block</span>
<span class="sd">    that uses the output from the UNet to preform an grid_sample</span>
<span class="sd">    https://pytorch.org/docs/stable/nn.functional.html#grid-sample</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;bilinear&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Instiatiate the block</span>
<span class="sd">            :param size: size of input to the spatial transformer block</span>
<span class="sd">            :param mode: method of interpolation for grid_sampler</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SpatialTransformer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Create sampling grid</span>
        <span class="n">vectors</span> <span class="o">=</span> <span class="p">[</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">size</span> <span class="p">]</span> 
        <span class="n">grids</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">vectors</span><span class="p">)</span> 
        <span class="n">grid</span>  <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">grids</span><span class="p">)</span> <span class="c1"># y, x, z</span>
        <span class="n">grid</span>  <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1">#add batch</span>
        <span class="n">grid</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s1">&#39;grid&#39;</span><span class="p">,</span> <span class="n">grid</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">flow</span><span class="p">):</span>   
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Push the src and flow through the spatial transform block</span>
<span class="sd">            :param src: the original moving image</span>
<span class="sd">            :param flow: the output from the U-Net</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">new_locs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span> <span class="o">+</span> <span class="n">flow</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">new_locs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="p">[:,:,:</span><span class="nb">list</span><span class="p">(</span><span class="n">flow</span><span class="o">.</span><span class="n">shape</span><span class="p">)[</span><span class="mi">2</span><span class="p">],:]</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="n">flow</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>

        <span class="c1"># Need to normalize grid values to [-1, 1] for resampler</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)):</span>
            <span class="n">new_locs</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">new_locs</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="o">...</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">new_locs</span> <span class="o">=</span> <span class="n">new_locs</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> 
            <span class="n">new_locs</span> <span class="o">=</span> <span class="n">new_locs</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">new_locs</span> <span class="o">=</span> <span class="n">new_locs</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> 
            <span class="n">new_locs</span> <span class="o">=</span> <span class="n">new_locs</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]]</span>

        <span class="k">return</span> <span class="n">F</span><span class="o">.</span><span class="n">grid_sample</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">new_locs</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">gradient_loss</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">penalty</span><span class="o">=</span><span class="s1">&#39;l2&#39;</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">s</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">s</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span> 
        <span class="n">dx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">s</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">:,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">s</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:])</span> 
        <span class="n">dz</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">s</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">s</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> 
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">s</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">s</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span> 
        <span class="n">dx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">s</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">:,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">s</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:])</span> 
        <span class="n">dz</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">s</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">s</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> 

    <span class="k">if</span><span class="p">(</span><span class="n">penalty</span> <span class="o">==</span> <span class="s1">&#39;l2&#39;</span><span class="p">):</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="n">dy</span> <span class="o">*</span> <span class="n">dy</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">dx</span>
        <span class="n">dz</span> <span class="o">=</span> <span class="n">dz</span> <span class="o">*</span> <span class="n">dz</span>

    <span class="n">d</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dx</span><span class="p">)</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dy</span><span class="p">)</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dz</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">d</span> <span class="o">/</span> <span class="mf">3.0</span>


<span class="k">def</span> <span class="nf">mse_loss</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="p">)</span> 


<span class="k">def</span> <span class="nf">diceLoss</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">):</span>
    <span class="n">top</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">y_true</span> <span class="o">*</span> <span class="n">y_pred</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">bottom</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">((</span><span class="n">y_true</span> <span class="o">+</span> <span class="n">y_pred</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="mi">50</span><span class="p">)</span>
    <span class="n">dice</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">top</span> <span class="o">/</span> <span class="n">bottom</span><span class="p">)</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">dice</span>


<span class="k">def</span> <span class="nf">ncc_loss</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">J</span><span class="p">,</span> <span class="n">win</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    calculate the normalize cross correlation between I and J</span>
<span class="sd">    assumes I, J are sized [batch_size, *vol_shape, nb_feats]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ndims</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">I</span><span class="o">.</span><span class="n">size</span><span class="p">()))</span> <span class="o">-</span> <span class="mi">2</span>
    <span class="k">assert</span> <span class="n">ndims</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="s2">&quot;volumes should be 1 to 3 dimensions. found: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">ndims</span>

    <span class="k">if</span> <span class="n">win</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">win</span> <span class="o">=</span> <span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">*</span> <span class="n">ndims</span>

    <span class="n">conv_fn</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="s1">&#39;conv</span><span class="si">%d</span><span class="s1">d&#39;</span> <span class="o">%</span> <span class="n">ndims</span><span class="p">)</span>
    <span class="n">I2</span> <span class="o">=</span> <span class="n">I</span><span class="o">*</span><span class="n">I</span>
    <span class="n">J2</span> <span class="o">=</span> <span class="n">J</span><span class="o">*</span><span class="n">J</span>
    <span class="n">IJ</span> <span class="o">=</span> <span class="n">I</span><span class="o">*</span><span class="n">J</span>

    <span class="n">sum_filt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">*</span><span class="n">win</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cuda&quot;</span><span class="p">)</span>

    <span class="n">pad_no</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">win</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ndims</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">stride</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">padding</span> <span class="o">=</span> <span class="p">(</span><span class="n">pad_no</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">ndims</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">stride</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">padding</span> <span class="o">=</span> <span class="p">(</span><span class="n">pad_no</span><span class="p">,</span> <span class="n">pad_no</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">stride</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">padding</span> <span class="o">=</span> <span class="p">(</span><span class="n">pad_no</span><span class="p">,</span> <span class="n">pad_no</span><span class="p">,</span> <span class="n">pad_no</span><span class="p">)</span>
    
    <span class="n">I_var</span><span class="p">,</span> <span class="n">J_var</span><span class="p">,</span> <span class="n">cross</span> <span class="o">=</span> <span class="n">compute_local_sums</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">J</span><span class="p">,</span> <span class="n">sum_filt</span><span class="p">,</span> <span class="n">stride</span><span class="p">,</span> <span class="n">padding</span><span class="p">,</span> <span class="n">win</span><span class="p">)</span>

    <span class="n">cc</span> <span class="o">=</span> <span class="n">cross</span><span class="o">*</span><span class="n">cross</span> <span class="o">/</span> <span class="p">(</span><span class="n">I_var</span><span class="o">*</span><span class="n">J_var</span> <span class="o">+</span> <span class="mf">1e-5</span><span class="p">)</span>

    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span>



<span class="k">def</span> <span class="nf">compute_local_sums</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">J</span><span class="p">,</span> <span class="n">filt</span><span class="p">,</span> <span class="n">stride</span><span class="p">,</span> <span class="n">padding</span><span class="p">,</span> <span class="n">win</span><span class="p">):</span>
    <span class="n">I2</span> <span class="o">=</span> <span class="n">I</span> <span class="o">*</span> <span class="n">I</span>
    <span class="n">J2</span> <span class="o">=</span> <span class="n">J</span> <span class="o">*</span> <span class="n">J</span>
    <span class="n">IJ</span> <span class="o">=</span> <span class="n">I</span> <span class="o">*</span> <span class="n">J</span>

    <span class="n">I_sum</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">conv2d</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">filt</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="n">stride</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="n">padding</span><span class="p">)</span>
    <span class="n">J_sum</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">conv2d</span><span class="p">(</span><span class="n">J</span><span class="p">,</span> <span class="n">filt</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="n">stride</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="n">padding</span><span class="p">)</span>
    <span class="n">I2_sum</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">conv2d</span><span class="p">(</span><span class="n">I2</span><span class="p">,</span> <span class="n">filt</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="n">stride</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="n">padding</span><span class="p">)</span>
    <span class="n">J2_sum</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">conv2d</span><span class="p">(</span><span class="n">J2</span><span class="p">,</span> <span class="n">filt</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="n">stride</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="n">padding</span><span class="p">)</span>
    <span class="n">IJ_sum</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">conv2d</span><span class="p">(</span><span class="n">IJ</span><span class="p">,</span> <span class="n">filt</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="n">stride</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="n">padding</span><span class="p">)</span>

    <span class="n">win_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">win</span><span class="p">)</span>
    <span class="n">u_I</span> <span class="o">=</span> <span class="n">I_sum</span> <span class="o">/</span> <span class="n">win_size</span>
    <span class="n">u_J</span> <span class="o">=</span> <span class="n">J_sum</span> <span class="o">/</span> <span class="n">win_size</span>

    <span class="n">cross</span> <span class="o">=</span> <span class="n">IJ_sum</span> <span class="o">-</span> <span class="n">u_J</span> <span class="o">*</span> <span class="n">I_sum</span> <span class="o">-</span> <span class="n">u_I</span> <span class="o">*</span> <span class="n">J_sum</span> <span class="o">+</span> <span class="n">u_I</span> <span class="o">*</span> <span class="n">u_J</span> <span class="o">*</span> <span class="n">win_size</span>
    <span class="n">I_var</span> <span class="o">=</span> <span class="n">I2_sum</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">u_I</span> <span class="o">*</span> <span class="n">I_sum</span> <span class="o">+</span> <span class="n">u_I</span> <span class="o">*</span> <span class="n">u_I</span> <span class="o">*</span> <span class="n">win_size</span>
    <span class="n">J_var</span> <span class="o">=</span> <span class="n">J2_sum</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">u_J</span> <span class="o">*</span> <span class="n">J_sum</span> <span class="o">+</span> <span class="n">u_J</span> <span class="o">*</span> <span class="n">u_J</span> <span class="o">*</span> <span class="n">win_size</span>

    <span class="k">return</span> <span class="n">I_var</span><span class="p">,</span> <span class="n">J_var</span><span class="p">,</span> <span class="n">cross</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cuda&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">nb_enc_features</span> <span class="o">=</span> <span class="p">[</span><span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">]</span>
<span class="n">nb_dec_features</span> <span class="o">=</span> <span class="p">[</span><span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">16</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">FramePredNet</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;&quot;&quot; implementation of voxelmorph.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vol_size</span><span class="p">,</span> <span class="n">enc_nf</span><span class="p">,</span> <span class="n">dec_nf</span><span class="p">,</span> <span class="n">full_size</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Instiatiate 2018 model</span>
<span class="sd">            :param vol_size: volume size of the atlas</span>
<span class="sd">            :param enc_nf: the number of features maps for encoding stages</span>
<span class="sd">            :param dec_nf: the number of features maps for decoding stages</span>
<span class="sd">            :param full_size: boolean value full amount of decoding layers</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FramePredNet</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="n">dim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vol_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unet_model</span> <span class="o">=</span> <span class="n">Unet</span><span class="p">(</span><span class="n">vol_size</span><span class="p">,</span> <span class="p">[</span><span class="n">enc_nf</span><span class="p">,</span> <span class="n">dec_nf</span><span class="p">])</span>

        <span class="c1"># One conv to get the flow field</span>
        <span class="n">conv_fn</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">nn</span><span class="p">,</span> <span class="s1">&#39;Conv</span><span class="si">%d</span><span class="s1">d&#39;</span> <span class="o">%</span> <span class="n">dim</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flow</span> <span class="o">=</span> <span class="n">conv_fn</span><span class="p">(</span><span class="n">dec_nf</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">dim</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>      

        <span class="c1"># Make flow weights + bias small. Not sure this is necessary.</span>
        <span class="n">nd</span> <span class="o">=</span> <span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1e-5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">nd</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">bias</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">spatial_transform</span> <span class="o">=</span> <span class="n">SpatialTransformer</span><span class="p">(</span><span class="n">vol_size</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">tgt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Pass input x through forward once</span>
<span class="sd">            :param src: moving image that we want to shift</span>
<span class="sd">            :param tgt: fixed image that we want to shift to</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">src</span><span class="p">,</span> <span class="n">tgt</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unet_model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">flow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spatial_transform</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">flow</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">y</span><span class="p">,</span> <span class="n">flow</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fpnet</span> <span class="o">=</span> <span class="n">FramePredNet</span><span class="p">(</span><span class="n">vol_shape</span><span class="p">,</span><span class="n">nb_enc_features</span><span class="p">,</span><span class="n">nb_dec_features</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fpnet</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>FramePredNet(
  (unet_model): Unet(
    (upsample): Upsample(scale_factor=2.0, mode=nearest)
    (downarm): ModuleList(
      (0): ConvBlock(
        (main): Conv2d(2, 32, kernel_size=(3, 3), stride=(2, 2), padding=(1, 1))
        (activation): LeakyReLU(negative_slope=0.2)
      )
      (1): ConvBlock(
        (main): Conv2d(32, 32, kernel_size=(3, 3), stride=(2, 2), padding=(1, 1))
        (activation): LeakyReLU(negative_slope=0.2)
      )
      (2): ConvBlock(
        (main): Conv2d(32, 32, kernel_size=(3, 3), stride=(2, 2), padding=(1, 1))
        (activation): LeakyReLU(negative_slope=0.2)
      )
      (3): ConvBlock(
        (main): Conv2d(32, 32, kernel_size=(3, 3), stride=(2, 2), padding=(1, 1))
        (activation): LeakyReLU(negative_slope=0.2)
      )
    )
    (uparm): ModuleList(
      (0): ConvBlock(
        (main): Conv2d(32, 32, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
        (activation): LeakyReLU(negative_slope=0.2)
      )
      (1): ConvBlock(
        (main): Conv2d(64, 32, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
        (activation): LeakyReLU(negative_slope=0.2)
      )
      (2): ConvBlock(
        (main): Conv2d(64, 32, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
        (activation): LeakyReLU(negative_slope=0.2)
      )
      (3): ConvBlock(
        (main): Conv2d(64, 32, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
        (activation): LeakyReLU(negative_slope=0.2)
      )
    )
    (extras): ModuleList(
      (0): ConvBlock(
        (main): Conv2d(34, 32, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
        (activation): LeakyReLU(negative_slope=0.2)
      )
      (1): ConvBlock(
        (main): Conv2d(32, 16, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
        (activation): LeakyReLU(negative_slope=0.2)
      )
    )
  )
  (flow): Conv2d(16, 2, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
  (spatial_transform): SpatialTransformer()
)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>
<span class="kn">from</span> <span class="nn">torch.optim</span> <span class="kn">import</span> <span class="n">Adam</span>
<span class="n">lr</span> <span class="o">=</span> <span class="mf">0.001</span>
<span class="n">n_iter</span> <span class="o">=</span> <span class="mi">8000</span>
<span class="n">reg_param</span> <span class="o">=</span> <span class="mf">0.015</span>
<span class="n">opt</span> <span class="o">=</span> <span class="n">Adam</span><span class="p">(</span><span class="n">fpnet</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">)</span>
<span class="n">data_loss</span> <span class="o">=</span> <span class="s1">&#39;mse&#39;</span>
<span class="n">sim_loss_fn</span> <span class="o">=</span> <span class="n">ncc_loss</span> <span class="k">if</span> <span class="n">data_loss</span> <span class="o">==</span> <span class="s2">&quot;ncc&quot;</span> <span class="k">else</span> <span class="n">mse_loss</span>
<span class="n">grad_loss_fn</span> <span class="o">=</span> <span class="n">gradient_loss</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">train</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">if</span> <span class="n">train</span><span class="p">:</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> 
    <span class="k">for</span> <span class="n">old</span><span class="p">,</span><span class="n">new</span> <span class="ow">in</span> <span class="n">loader</span><span class="p">:</span>
        <span class="c1"># Generate the moving images and convert them to tensors.</span>
        <span class="n">moving_image</span><span class="p">,</span> <span class="n">input_fixed</span>  <span class="o">=</span> <span class="n">old</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">new</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
       
        <span class="n">input_moving</span> <span class="o">=</span> <span class="n">moving_image</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
        <span class="c1">#input_moving = input_moving.permute(0, 3, 1, 2)</span>

        <span class="n">input_fixed</span>  <span class="o">=</span> <span class="n">input_fixed</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
        <span class="c1">#input_fixed  = input_fixed.permute(0, 3, 1, 2)        </span>

        <span class="c1"># Run the data through the model to produce warp and flow field</span>
        <span class="n">warp</span><span class="p">,</span> <span class="n">flow</span> <span class="o">=</span> <span class="n">fpnet</span><span class="p">(</span><span class="n">input_moving</span><span class="p">,</span> <span class="n">input_fixed</span><span class="p">)</span>

        <span class="c1"># Calculate loss</span>
        <span class="n">recon_loss</span> <span class="o">=</span> <span class="n">sim_loss_fn</span><span class="p">(</span><span class="n">warp</span><span class="p">,</span> <span class="n">input_fixed</span><span class="p">)</span>
        <span class="n">grad_loss</span> <span class="o">=</span> <span class="n">grad_loss_fn</span><span class="p">(</span><span class="n">flow</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">=</span>  <span class="n">recon_loss</span> <span class="o">+</span> <span class="n">reg_param</span> <span class="o">*</span> <span class="n">grad_loss</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">,</span><span class="si">%f</span><span class="s2">,</span><span class="si">%f</span><span class="s2">,</span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="n">recon_loss</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="n">grad_loss</span><span class="o">.</span><span class="n">item</span><span class="p">()),</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Backwards and optimize</span>
        <span class="n">opt</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
        <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
        <span class="n">opt</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">save_file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s1">&#39;deformation_5objs_latest.pt&#39;</span><span class="p">)</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">fpnet</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="n">save_file_name</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0,6497.458496,6497.458496,0.000000
1,37.764408,37.761917,0.166102
2,32.692089,32.690269,0.121394
3,13.145593,13.145446,0.009795
4,180.017563,180.017380,0.012302
5,164.921753,164.920990,0.050777
6,13.704789,13.704455,0.022225
7,12.541230,12.541147,0.005543
8,183.336227,183.336227,0.000314
9,9.726167,9.726140,0.001804
10,9.086883,9.086849,0.002232
11,8.320355,8.320333,0.001501
12,30.687416,30.687403,0.000934
13,200.564346,200.564331,0.000885
14,7.542757,7.542750,0.000490
15,7.552512,7.552500,0.000775
16,26.674955,26.674940,0.001072
17,168.292618,168.292603,0.000842
18,8.485906,8.485893,0.000821
19,6.713073,6.713059,0.000916
20,7.119402,7.119374,0.001915
21,6.442109,6.442076,0.002237
22,310.897430,310.897400,0.001943
23,25.985098,25.985083,0.000993
24,6.646648,6.646630,0.001223
25,38.873253,38.873234,0.001284
26,425.139557,425.139526,0.002354
27,5.537656,5.537633,0.001556
28,5.502376,5.502356,0.001354
29,5.495192,5.495169,0.001486
30,22.187490,22.187468,0.001513
31,206.053726,206.053696,0.002221
32,5.963037,5.962993,0.002919
33,5.548494,5.548461,0.002241
34,4.939898,4.939874,0.001632
35,561.801025,561.800964,0.002510
36,6.838946,6.838898,0.003215
37,4.800401,4.800372,0.001920
38,4.890824,4.890795,0.001958
39,5.068452,5.068416,0.002381
40,239.692307,239.692276,0.002495
41,17.118317,17.118284,0.002166
42,4.333231,4.333200,0.002052
43,50.804127,50.804092,0.002228
44,392.813812,392.813782,0.002444
45,5.205127,5.205090,0.002452
46,4.606869,4.606833,0.002351
47,74.957275,74.957237,0.002300
48,4.291326,4.291291,0.002312
49,444.324615,444.324585,0.002632
50,4.775305,4.775267,0.002507
51,4.744421,4.744384,0.002484
52,11.959225,11.959189,0.002379
53,252.365417,252.365372,0.002835
54,7.472833,7.472795,0.002523
55,4.706389,4.706348,0.002777
56,4.000462,4.000417,0.003030
57,3.792920,3.792872,0.003217
58,618.391785,618.391663,0.006687
59,4.185783,4.185727,0.003721
60,4.368200,4.368145,0.003661
61,6.231583,6.231529,0.003592
62,552.639832,552.639648,0.012817
63,3.682194,3.682147,0.003179
64,3.417124,3.417068,0.003681
65,3.413906,3.413833,0.004848
66,25.601942,25.601852,0.006037
67,254.274460,254.274246,0.014433
68,3.680347,3.680257,0.005986
69,3.550388,3.550307,0.005426
70,31.517414,31.517311,0.006863
71,79.797073,79.796829,0.016374
72,5.331400,5.331208,0.012808
73,4.023260,4.023131,0.008571
74,5.420501,5.420284,0.014477
75,3.997721,3.997521,0.013315
76,80.902466,80.902252,0.014348
77,4.093969,4.093848,0.008103
78,4.192214,4.192122,0.006175
79,5.432484,5.432407,0.005163
80,13.038890,13.038813,0.005151
81,3.921356,3.921288,0.004523
82,3.226351,3.226285,0.004381
83,2.978292,2.978222,0.004645
84,3.239496,3.239420,0.005084
85,195.393021,195.392899,0.008549
86,3.243718,3.243606,0.007431
87,3.348650,3.348530,0.008000
88,32.409481,32.409374,0.007158
89,577.378662,577.377808,0.057671
90,3.076495,3.076417,0.005240
91,3.742520,3.742429,0.006018
92,3.090460,3.090338,0.008080
93,3.135967,3.135745,0.014831
94,517.845886,517.841187,0.315116
95,7.507407,7.506933,0.031596
96,3.711178,3.710858,0.021284
97,13.239008,13.238442,0.037685
98,105.347588,105.334641,0.863215
99,6.144554,6.143668,0.059075
100,4.894633,4.893854,0.051958
101,3.866505,3.865714,0.052748
102,189.484528,189.408646,5.058968
103,3.996107,3.995416,0.046086
104,5.311914,5.311180,0.048953
105,4.721871,4.721072,0.053300
106,22.828537,22.825047,0.232669
107,295.596985,295.186951,27.334942
108,4.499934,4.499087,0.056441
109,4.378980,4.378343,0.042474
110,28.989946,28.989393,0.036877
111,4.500497,4.500082,0.027631
112,373.205841,373.205475,0.024664
113,5.228292,5.228050,0.016138
114,4.922992,4.922797,0.012967
115,18.699724,18.699556,0.011164
116,117.971016,117.970856,0.010631
117,5.822562,5.822358,0.013586
118,4.747872,4.747760,0.007495
119,6.846033,6.845813,0.014674
120,546.781006,546.780518,0.033111
121,7.972880,7.972753,0.008458
122,3.998756,3.998554,0.013442
123,4.911378,4.911211,0.011150
124,33.569027,33.568527,0.033234
125,402.126556,402.124420,0.142050
126,6.372011,6.371430,0.038767
127,6.557664,6.557109,0.036999
128,3.939497,3.939348,0.009905
129,4.632147,4.632036,0.007403
130,37.455784,37.455627,0.010413
131,4.744842,4.744692,0.009941
132,4.198380,4.198279,0.006749
133,43.203770,43.203697,0.004919
134,4.553544,4.553482,0.004101
135,4.760857,4.760777,0.005309
136,4.552505,4.552453,0.003513
137,4.370286,4.370227,0.003963
138,14.389585,14.389483,0.006719
139,4.230917,4.230797,0.007953
140,6.306021,6.305934,0.005778
141,4.396436,4.396367,0.004604
142,258.112122,258.112030,0.005930
143,4.450982,4.450890,0.006110
144,4.435209,4.435123,0.005765
145,18.239716,18.239651,0.004352
146,343.189697,343.189545,0.010947
147,4.243820,4.243742,0.005229
148,3.851938,3.851859,0.005238
149,3.943512,3.943446,0.004416
150,3.951298,3.951231,0.004454
151,632.934448,632.933228,0.081726
152,3.519461,3.519376,0.005727
153,3.880617,3.880531,0.005734
154,4.206617,4.206497,0.008028
155,70.380676,70.380043,0.042296
156,6.927636,6.927446,0.012628
157,21.947483,21.946623,0.057378
158,11.571051,11.570889,0.010752
159,20.990273,20.990110,0.010756
160,488.441040,488.437744,0.220356
161,5.010396,5.010134,0.017467
162,7.042328,7.041969,0.023936
163,16.184656,16.184450,0.013749
164,136.922134,136.918610,0.234722
165,5.516968,5.516756,0.014184
166,5.110192,5.110038,0.010288
167,15.340808,15.340602,0.013745
168,4.557229,4.557062,0.011134
169,125.798126,125.785362,0.851184
170,5.124773,5.124410,0.024180
171,5.196053,5.195641,0.027473
172,5.803378,5.803013,0.024364
173,112.237808,112.198578,2.615428
174,5.562547,5.561838,0.047309
175,4.870254,4.869709,0.036267
176,4.596796,4.596250,0.036392
177,4.950268,4.949561,0.047149
178,87.625565,87.531601,6.264331
179,4.591483,4.590637,0.056407
180,7.339795,7.338266,0.101907
181,5.427411,5.425820,0.106004
182,30.020006,29.978699,2.753849
183,4.178414,4.176938,0.098452
184,4.048848,4.047461,0.092486
185,4.401186,4.399849,0.089102
186,69.063911,68.765007,19.927015
187,18.779215,18.753864,1.690020
188,5.160125,5.159291,0.055584
189,4.233915,4.233346,0.037957
190,23.944427,23.930128,0.953321
191,210.588806,210.433487,10.354409
192,4.578473,4.578047,0.028423
193,4.426763,4.426372,0.026072
194,23.473318,23.467672,0.376398
195,5.927239,5.926208,0.068689
196,352.147949,351.340851,53.806164
197,6.198597,6.197415,0.078814
198,5.531940,5.531019,0.061450
199,9.706484,9.705269,0.080975
200,48.420612,48.231457,12.610438
201,5.877305,5.876252,0.070147
202,9.387589,9.386115,0.098230
203,6.948053,6.946325,0.115221
204,91.171463,90.900894,18.038105
205,7.358476,7.356653,0.121548
206,5.533244,5.531433,0.120763
207,7.575775,7.573434,0.156068
208,5.336005,5.334010,0.132964
209,442.031006,439.875275,143.715790
210,20.444912,20.441751,0.210756
211,12.536901,12.535452,0.096644
212,52.651855,52.633484,1.224687
213,15.098417,15.095715,0.180194
214,146.715363,146.261002,30.290241
215,16.555691,16.554079,0.107408
216,12.608523,12.607585,0.062570
217,9.678734,9.677842,0.059420
218,30.471613,30.464964,0.443320
219,5.264663,5.264484,0.011929
220,8.030340,8.029506,0.055628
221,8.125108,8.124228,0.058633
222,85.589699,85.521812,4.525875
223,5.969231,5.969088,0.009530
224,7.309106,7.308800,0.020434
225,5.370643,5.370534,0.007285
226,4.703967,4.703795,0.011484
227,206.563095,206.556076,0.467598
228,6.110492,6.109974,0.034521
229,4.808315,4.808156,0.010588
230,4.954266,4.954180,0.005737
231,5.218604,5.218462,0.009436
232,276.321472,276.319824,0.110811
233,4.399605,4.399464,0.009436
234,8.942548,8.942247,0.020058
235,4.479096,4.478885,0.014096
236,38.497505,38.496170,0.089078
237,4.704425,4.704346,0.005311
238,4.347454,4.347373,0.005368
239,4.014314,4.014215,0.006591
240,30.149481,30.149225,0.017007
241,4.978992,4.978883,0.007280
242,3.862601,3.862521,0.005289
243,3.919084,3.919005,0.005214
244,3.774141,3.774048,0.006174
245,234.888184,234.880173,0.534296
246,3.799204,3.799064,0.009360
247,3.694633,3.694516,0.007808
248,11.301555,11.300711,0.056268
249,5.130127,5.130027,0.006629
250,270.992615,270.764618,15.200628
251,3.652598,3.652461,0.009140
252,33.310059,33.291794,1.217555
253,5.284556,5.284256,0.019974
254,298.396881,298.106659,19.348181
255,4.191291,4.190999,0.019488
256,6.656976,6.656655,0.021397
257,45.841259,45.833122,0.542377
258,227.505981,227.023453,32.168079
259,6.410053,6.409821,0.015468
260,4.973380,4.973095,0.018970
261,7.123013,7.122635,0.025187
262,26.359034,26.319458,2.638368
263,252.993362,252.048477,62.992485
264,5.751922,5.751673,0.016612
265,6.479440,6.479043,0.026446
266,13.350635,13.347279,0.223727
267,6.973058,6.972736,0.021444
268,81.014626,80.871986,9.509090
269,4.452511,4.452188,0.021561
270,9.100903,9.100159,0.049616
271,4.282208,4.281953,0.017012
272,23.307816,23.278860,1.930390
273,4.073989,4.073804,0.012381
274,4.935879,4.935702,0.011793
275,8.678267,8.676386,0.125466
276,17.781136,17.780033,0.073465
277,4.284546,4.284400,0.009691
278,3.848605,3.848409,0.013078
279,4.102587,4.102399,0.012525
280,3.809279,3.809147,0.008794
281,78.567314,78.525024,2.819560
282,3.868964,3.868832,0.008766
283,28.902439,28.900187,0.150117
284,3.420171,3.420059,0.007464
285,3.594066,3.593956,0.007329
286,95.195335,95.007721,12.507755
287,5.705455,5.705332,0.008171
288,14.899425,14.894061,0.357575
289,6.085381,6.085199,0.012109
290,94.091171,93.976669,7.633456
291,5.070717,5.070572,0.009659
292,4.503181,4.503029,0.010168
293,71.414963,71.140198,18.317513
294,65.365738,64.514809,56.728683
295,18.026192,17.996576,1.974346
296,4.287024,4.286793,0.015367
297,3.361862,3.361682,0.011988
298,17.959854,17.954798,0.337043
299,103.300140,102.720482,38.643997
300,3.632776,3.632542,0.015595
301,3.765522,3.765278,0.016265
302,4.227058,4.226909,0.009933
303,3.450473,3.450341,0.008782
304,273.421265,273.115082,20.411863
305,4.341418,4.341276,0.009465
306,92.716141,92.690720,1.694508
307,3.067001,3.066812,0.012656
308,519.895142,519.118225,51.794449
309,35.412037,35.410759,0.085280
310,74.790955,74.752708,2.549969
311,69.378807,69.373489,0.354359
312,183.362518,182.345612,67.793533
313,28.434235,28.431013,0.214752
314,11.167187,11.165689,0.099876
315,21.392334,21.391993,0.022795
316,60.012768,59.960102,3.510966
317,448.888214,448.028320,57.326347
318,6.784513,6.784249,0.017617
319,22.179609,22.179304,0.020314
320,6.547755,6.547507,0.016528
321,6.595774,6.595497,0.018436
322,157.282364,157.018204,17.610950
323,8.474428,8.474092,0.022393
324,20.576744,20.576410,0.022239
325,6.993746,6.993460,0.019073
326,292.068146,290.716827,90.088463
327,1576.791626,1535.776001,2734.373779
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Please uncomment this the line below if you would like to load the saved model</span>
<span class="n">fpnet</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;deformation_5objs_latest.pt&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;All keys matched successfully&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">video_dataset</span> <span class="o">=</span> <span class="n">VideoFrameDataset</span><span class="p">(</span><span class="n">VIDEO_PATH</span><span class="p">)</span>
<span class="n">loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">video_dataset</span><span class="p">,</span><span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fpnet</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>FramePredNet(
  (unet_model): Unet(
    (upsample): Upsample(scale_factor=2.0, mode=nearest)
    (downarm): ModuleList(
      (0): ConvBlock(
        (main): Conv2d(2, 32, kernel_size=(3, 3), stride=(2, 2), padding=(1, 1))
        (activation): LeakyReLU(negative_slope=0.2)
      )
      (1): ConvBlock(
        (main): Conv2d(32, 32, kernel_size=(3, 3), stride=(2, 2), padding=(1, 1))
        (activation): LeakyReLU(negative_slope=0.2)
      )
      (2): ConvBlock(
        (main): Conv2d(32, 32, kernel_size=(3, 3), stride=(2, 2), padding=(1, 1))
        (activation): LeakyReLU(negative_slope=0.2)
      )
      (3): ConvBlock(
        (main): Conv2d(32, 32, kernel_size=(3, 3), stride=(2, 2), padding=(1, 1))
        (activation): LeakyReLU(negative_slope=0.2)
      )
    )
    (uparm): ModuleList(
      (0): ConvBlock(
        (main): Conv2d(32, 32, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
        (activation): LeakyReLU(negative_slope=0.2)
      )
      (1): ConvBlock(
        (main): Conv2d(64, 32, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
        (activation): LeakyReLU(negative_slope=0.2)
      )
      (2): ConvBlock(
        (main): Conv2d(64, 32, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
        (activation): LeakyReLU(negative_slope=0.2)
      )
      (3): ConvBlock(
        (main): Conv2d(64, 32, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
        (activation): LeakyReLU(negative_slope=0.2)
      )
    )
    (extras): ModuleList(
      (0): ConvBlock(
        (main): Conv2d(34, 32, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
        (activation): LeakyReLU(negative_slope=0.2)
      )
      (1): ConvBlock(
        (main): Conv2d(32, 16, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
        (activation): LeakyReLU(negative_slope=0.2)
      )
    )
  )
  (flow): Conv2d(16, 2, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
  (spatial_transform): SpatialTransformer()
)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">flow2hsv</span><span class="p">(</span><span class="n">flow</span><span class="p">,</span> <span class="n">show_style</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">mag</span><span class="p">,</span> <span class="n">ang</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cartToPolar</span><span class="p">(</span><span class="n">flow</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">flow</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>


    <span class="n">hsv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">flow</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">flow</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">show_style</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">hsv</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ang</span>  <span class="o">*</span> <span class="mi">180</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">hsv</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span>
        <span class="n">hsv</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">mag</span> <span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">NORM_MINMAX</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">show_style</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">hsv</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ang</span>  <span class="o">*</span> <span class="mi">180</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">hsv</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">mag</span> <span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">NORM_MINMAX</span><span class="p">)</span>
        <span class="n">hsv</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span>
    <span class="n">bgr</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">hsv</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_HSV2BGR</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">bgr</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">draw_hsv</span><span class="p">(</span><span class="n">flow</span><span class="p">):</span>
    <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">flow</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">fx</span><span class="p">,</span> <span class="n">fy</span> <span class="o">=</span> <span class="n">flow</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">flow</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">ang</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">fy</span><span class="p">,</span> <span class="n">fx</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">fx</span><span class="o">*</span><span class="n">fx</span><span class="o">+</span><span class="n">fy</span><span class="o">*</span><span class="n">fy</span><span class="p">)</span>
    <span class="n">hsv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
    <span class="n">hsv</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ang</span><span class="o">*</span><span class="p">(</span><span class="mi">180</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">hsv</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span>
    <span class="n">hsv</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">v</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
    <span class="n">bgr</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">hsv</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_HSV2BGR</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">bgr</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">draw_flow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">flow</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">16</span><span class="p">):</span>
    <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">y</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span><span class="n">step</span><span class="o">/</span><span class="mi">2</span><span class="p">:</span><span class="n">h</span><span class="p">:</span><span class="n">step</span><span class="p">,</span> <span class="n">step</span><span class="o">/</span><span class="mi">2</span><span class="p">:</span><span class="n">w</span><span class="p">:</span><span class="n">step</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">fx</span><span class="p">,</span> <span class="n">fy</span> <span class="o">=</span> <span class="n">flow</span><span class="p">[</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="n">fx</span><span class="p">,</span> <span class="n">y</span><span class="o">+</span><span class="n">fy</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">lines</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>
    <span class="c1">#For fpnet</span>
    <span class="n">vis</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">img</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_GRAY2BGR</span><span class="p">)</span>
    <span class="c1">#vis = cv2.cvtColor(img, cv2.COLOR_GRAY2BGR)</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">polylines</span><span class="p">(</span><span class="n">vis</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">),</span> <span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">)</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">circle</span><span class="p">(</span><span class="n">vis</span><span class="p">,</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">vis</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">old</span><span class="p">,</span><span class="n">new</span> <span class="ow">in</span> <span class="n">loader</span><span class="p">:</span>
    <span class="c1"># Generate the moving images and convert them to tensors.</span>
    <span class="n">moving_image</span><span class="p">,</span> <span class="n">input_fixed</span>  <span class="o">=</span> <span class="n">old</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">new</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="n">input_moving</span> <span class="o">=</span> <span class="n">moving_image</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
  
    <span class="n">input_fixed</span>  <span class="o">=</span> <span class="n">input_fixed</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
    
    <span class="c1"># Run the data through the model to produce warp and flow field</span>
    <span class="n">warp</span><span class="p">,</span> <span class="n">flow</span> <span class="o">=</span> <span class="n">fpnet</span><span class="p">(</span><span class="n">input_moving</span><span class="p">,</span> <span class="n">input_fixed</span><span class="p">)</span>
    <span class="n">_flow</span> <span class="o">=</span> <span class="n">flow</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="n">_flow</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="n">_flow</span><span class="p">)</span>
    <span class="n">_flow_img</span> <span class="o">=</span> <span class="n">flow2hsv</span><span class="p">(</span><span class="n">_flow</span><span class="p">,</span><span class="n">show_style</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="c1">#_flow_img = draw_flow(moving_image.squeeze(),flow.detach().cpu().squeeze().permute(1,2,0).numpy())</span>
    <span class="c1">#_flow = flow.detach().cpu().squeeze().permute(1,2,0).numpy()</span>
    <span class="c1">#_flow_img = draw_flow(moving_image.squeeze(),_flow)</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span><span class="mi">5</span><span class="p">:</span>
      <span class="k">break</span>
    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">cv2_imshow</span><span class="p">(</span><span class="n">_flow_img</span><span class="p">)</span>
    
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/Self_supervised_optical_flow_estimation_26_0.png" src="../../_images/Self_supervised_optical_flow_estimation_26_0.png" />
<img alt="../../_images/Self_supervised_optical_flow_estimation_26_1.png" src="../../_images/Self_supervised_optical_flow_estimation_26_1.png" />
<img alt="../../_images/Self_supervised_optical_flow_estimation_26_2.png" src="../../_images/Self_supervised_optical_flow_estimation_26_2.png" />
<img alt="../../_images/Self_supervised_optical_flow_estimation_26_3.png" src="../../_images/Self_supervised_optical_flow_estimation_26_3.png" />
<img alt="../../_images/Self_supervised_optical_flow_estimation_26_4.png" src="../../_images/Self_supervised_optical_flow_estimation_26_4.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">warp_flow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">flow</span><span class="p">):</span>
    <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">flow</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">flow</span> <span class="o">=</span> <span class="o">-</span><span class="n">flow</span>
    <span class="n">flow</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
    <span class="n">flow</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">h</span><span class="p">)[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">remap</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">flow</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">INTER_LINEAR</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">res</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">randint</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">cam</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoCapture</span><span class="p">(</span><span class="n">VIDEO_PATH</span><span class="p">)</span>
<span class="n">ret</span><span class="p">,</span> <span class="n">prev</span> <span class="o">=</span> <span class="n">cam</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="n">width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cam</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FRAME_WIDTH</span><span class="p">))</span>
<span class="n">height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cam</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FRAME_HEIGHT</span><span class="p">))</span>
<span class="n">target_fps</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cam</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FPS</span><span class="p">))</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">ret</span><span class="p">:</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">prevgray</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">prev</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
<span class="n">video_writer</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoWriter</span><span class="p">(</span><span class="s1">&#39;overlay_output_results.mp4&#39;</span><span class="p">,</span>
                                   <span class="n">cv2</span><span class="o">.</span><span class="n">VideoWriter_fourcc</span><span class="p">(</span><span class="o">*</span><span class="s2">&quot;mp4v&quot;</span><span class="p">),</span>
                                   <span class="n">target_fps</span><span class="p">,</span>
                                   <span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">))</span>
<span class="n">i_frames</span> <span class="o">=</span> <span class="mi">0</span>
<span class="c1"># folder saving the flo files</span>
<span class="n">flows_folder</span> <span class="o">=</span> <span class="s1">&#39;/content/flows_results/flos&#39;</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">flows_folder</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">flows_folder</span><span class="p">)</span>

<span class="k">while</span> <span class="n">cam</span><span class="o">.</span><span class="n">isOpened</span><span class="p">():</span>
    <span class="n">ret</span><span class="p">,</span> <span class="n">img</span> <span class="o">=</span> <span class="n">cam</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">ret</span><span class="p">:</span>
      <span class="n">gray</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
      <span class="n">moving_image</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">prevgray</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  
      <span class="n">input_fixed</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">gray</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
      <span class="n">input_moving</span> <span class="o">=</span> <span class="n">moving_image</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>

      <span class="n">input_fixed</span>  <span class="o">=</span> <span class="n">input_fixed</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>

      <span class="c1"># Run the data through the model to produce warp and flow field</span>
      <span class="n">warp</span><span class="p">,</span> <span class="n">flow</span> <span class="o">=</span> <span class="n">fpnet</span><span class="p">(</span><span class="n">input_moving</span><span class="p">,</span> <span class="n">input_fixed</span><span class="p">)</span>
      <span class="n">_flow_c</span> <span class="o">=</span> <span class="n">flow</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
      <span class="c1">#flows.append(_flow_c) # np.rint round to int</span>
      <span class="n">flow_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">flows_folder</span><span class="p">,</span><span class="sa">f</span><span class="s1">&#39;flow_</span><span class="si">{</span><span class="n">i_frames</span><span class="si">:</span><span class="s1">06</span><span class="si">}</span><span class="s1">.flo&#39;</span><span class="p">)</span>
      <span class="n">write_flow</span><span class="p">(</span><span class="n">flow_filename</span><span class="p">,</span> <span class="n">_flow_c</span><span class="p">)</span>
      <span class="n">_flow_img</span> <span class="o">=</span> <span class="n">draw_hsv</span><span class="p">(</span><span class="n">_flow_c</span><span class="p">)</span>
      <span class="n">out_img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">addWeighted</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="mf">0.3</span><span class="p">,</span><span class="n">_flow_img</span><span class="p">,</span><span class="mf">0.7</span><span class="p">,</span><span class="mf">0.2</span><span class="p">)</span>
      <span class="n">video_writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out_img</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">i_frames</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
          <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;current frame: &#39;</span><span class="p">,</span><span class="n">i_frames</span><span class="p">)</span>
          <span class="n">cv2_imshow</span><span class="p">(</span><span class="n">_flow_img</span><span class="p">)</span>
          <span class="n">cv2_imshow</span><span class="p">(</span><span class="n">out_img</span><span class="p">)</span>
      <span class="n">prevgray</span> <span class="o">=</span> <span class="n">gray</span>
      <span class="n">i_frames</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">break</span>
      
<span class="n">cv2</span><span class="o">.</span><span class="n">destroyAllWindows</span><span class="p">()</span>
<span class="n">cam</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
<span class="n">video_writer</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>current frame:  0
</pre></div>
</div>
<img alt="../../_images/Self_supervised_optical_flow_estimation_28_1.png" src="../../_images/Self_supervised_optical_flow_estimation_28_1.png" />
<img alt="../../_images/Self_supervised_optical_flow_estimation_28_2.png" src="../../_images/Self_supervised_optical_flow_estimation_28_2.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>current frame:  100
</pre></div>
</div>
<img alt="../../_images/Self_supervised_optical_flow_estimation_28_4.png" src="../../_images/Self_supervised_optical_flow_estimation_28_4.png" />
<img alt="../../_images/Self_supervised_optical_flow_estimation_28_5.png" src="../../_images/Self_supervised_optical_flow_estimation_28_5.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>current frame:  200
</pre></div>
</div>
<img alt="../../_images/Self_supervised_optical_flow_estimation_28_7.png" src="../../_images/Self_supervised_optical_flow_estimation_28_7.png" />
<img alt="../../_images/Self_supervised_optical_flow_estimation_28_8.png" src="../../_images/Self_supervised_optical_flow_estimation_28_8.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>current frame:  300
</pre></div>
</div>
<img alt="../../_images/Self_supervised_optical_flow_estimation_28_10.png" src="../../_images/Self_supervised_optical_flow_estimation_28_10.png" />
<img alt="../../_images/Self_supervised_optical_flow_estimation_28_11.png" src="../../_images/Self_supervised_optical_flow_estimation_28_11.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># install flowiz for read .flo optiocal flow files
!pip install flowiz -U
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">flowiz</span> <span class="k">as</span> <span class="nn">fz</span>
<span class="n">flow_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;/content/flows_results/*.flo&#39;</span><span class="p">)</span>
<span class="n">uv</span> <span class="o">=</span> <span class="n">fz</span><span class="o">.</span><span class="n">convert_from_file</span><span class="p">(</span><span class="n">flow_files</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">uv</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.image.AxesImage at 0x7f8a48f69e80&gt;
</pre></div>
</div>
<img alt="../../_images/Self_supervised_optical_flow_estimation_30_1.png" src="../../_images/Self_supervised_optical_flow_estimation_30_1.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">uv</span> <span class="o">=</span> <span class="n">fz</span><span class="o">.</span><span class="n">read_flow</span><span class="p">(</span><span class="n">flow_files</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

<span class="n">f</span><span class="p">,</span> <span class="n">axarr</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="n">f</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

<span class="n">axarr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Horizontal Flow (U)&#39;</span><span class="p">)</span>
<span class="n">axarr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">uv</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;binary&#39;</span><span class="p">))</span>
<span class="n">axarr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Vertical Flow (V)&#39;</span><span class="p">)</span>
<span class="n">axarr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">uv</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;binary&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.image.AxesImage at 0x7f8a48eb4908&gt;
</pre></div>
</div>
<img alt="../../_images/Self_supervised_optical_flow_estimation_31_1.png" src="../../_images/Self_supervised_optical_flow_estimation_31_1.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Please uncomment the following file if you would like to convert flo files to png files and save them to a video file</span>
<span class="c1">#!python -m flowiz /content/flows_results/*.flo --outdir  /content/flows_results/png --videodir /content/flows_results/mp4</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>#Download the flo result files
!zip -r flows_results.zip /content/flows_results
from google.colab import files
files.download(&#39;/content/flows_results.zip&#39;)
</pre></div>
</div>
</div>
</div>
<p><em>Reference:</em></p>
<p><a class="reference external" href="https://arxiv.org/abs/1809.05231">VoxelMorph at TMI</a><br />
<a class="reference external" href="https://arxiv.org/abs/1903.03545">Diffeomorphic VoxelMorph at MedIA</a><br />
<a class="reference external" href="https://github.com/adalca/neuron">Neurite Library</a> - <a class="reference external" href="http://arxiv.org/abs/1903.03148">CVPR</a></p>
<p><a class="reference external" href="https://github.com/voxelmorph/voxelmorph">https://github.com/voxelmorph/voxelmorph</a></p>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./tutorials/tutorials"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            
                <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
            
        </div>
    </div>
    <footer class="footer">
  <p>
    
      By Chen Yang, Jeremy Forest, Matthew Einhorn, Thomas Cleland<br/>
    
        &copy; Copyright 2021.<br/>
  </p>
</footer>
</main>


      </div>
    </div>
  
  <script src="../../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>